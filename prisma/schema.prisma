generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ArtworkStatus {
  available
  reserved
  assigned
  activated
  shopify_failed
}

enum ReservationStatus {
  active
  confirmed
  expired
}

model Artwork {
  iris_id                 String          @id
  status                  ArtworkStatus
  rarity_code             String?
  image_url               String?
  pin_code                String?
  pin_last4               String?
  pin_attempts            Int?            @default(0)
  pin_locked_until        DateTime?
  assigned_order_id       String?
  assigned_customer_email String?
  activated_at            DateTime?
  created_at              DateTime        @default(now())
  updated_at              DateTime        @updatedAt

  events                  Event[]
  reservations            Reservation[]

  @@index([status])
  @@index([assigned_customer_email])
  @@index([activated_at])
}

model Event {
  event_id     String   @id @default(uuid()) @db.Uuid
  iris_id      String
  type         String
  actor        String
  payload_json Json
  created_at   DateTime @default(now())

  artwork      Artwork  @relation(fields: [iris_id], references: [iris_id], onDelete: Cascade)

  @@index([iris_id])
  @@index([type])
}

model Reservation {
  token       String            @id @default(uuid()) @db.Uuid
  iris_id     String
  status      ReservationStatus
  expires_at  DateTime
  created_at  DateTime          @default(now())

  artwork     Artwork           @relation(fields: [iris_id], references: [iris_id], onDelete: Cascade)

  @@index([iris_id])
  @@index([status])
  @@index([expires_at])
}

model WebhookReceipt {
  id                  Int      @id @default(autoincrement())
  topic               String
  shopify_webhook_id  String   @unique
  created_at          DateTime @default(now())
}
